// Ensure that the script is only run after the DOM has loaded
document.addEventListener("DOMContentLoaded", function() {

    // Function to generate a unique session ID (e.g., using a timestamp or a random string)
    function generateUniqueSessionID() {
        return 'session_' + new Date().getTime() + Math.random().toString(36).substring(2);
    }

    // Initialize session ID (store it in localStorage for persistence across pages)
    if (!localStorage.getItem('sessionID')) {
        localStorage.setItem('sessionID', generateUniqueSessionID());
    }
    const sessionID = localStorage.getItem('sessionID');

    // Function to log consent actions with the session ID
    function recordConsentAction(action) {
        const consentData = {
            sessionID: sessionID,
            action: action,  // 'accept', 'reject', 'customize'
            timestamp: new Date().toISOString(),
        };

        // Log consent data to Firebase or another backend (this example uses Firebase)
        firebase.database().ref('consent_logs').push(consentData);
    }

    // Listen for the "Accept All" button click
    const acceptAllBtn = document.getElementById('accept-all');
    if (acceptAllBtn) {
        acceptAllBtn.addEventListener('click', function() {
            // Update Google Consent Mode (example)
            gtag('consent', 'update', {
                'ad_storage': 'granted',
                'analytics_storage': 'granted',
                'functionality_storage': 'granted',
                'personalization_storage': 'granted',
            });

            // Record the consent action
            recordConsentAction('accept');
        });
    }

    // Listen for the "Reject All" button click
    const rejectAllBtn = document.getElementById('reject-all');
    if (rejectAllBtn) {
        rejectAllBtn.addEventListener('click', function() {
            // Update Google Consent Mode (example)
            gtag('consent', 'update', {
                'ad_storage': 'denied',
                'analytics_storage': 'denied',
                'functionality_storage': 'denied',
                'personalization_storage': 'denied',
            });

            // Record the consent action
            recordConsentAction('reject');
        });
    }

    // Listen for the "Customize" button click
    const customizeBtn = document.getElementById('customize');
    if (customizeBtn) {
        customizeBtn.addEventListener('click', function() {
            // Open the cookie preference customization panel
            document.getElementById('cookie-customization-panel').style.display = 'block';
        });
    }

    // Handle the "Save Preferences" button from the customization panel
    const savePreferencesBtn = document.getElementById('save-preferences');
    if (savePreferencesBtn) {
        savePreferencesBtn.addEventListener('click', function() {
            // Get the selected preferences (e.g., from checkboxes or toggles)
            const necessary = document.getElementById('necessary').checked;
            const functional = document.getElementById('functional').checked;
            const analytics = document.getElementById('analytics').checked;
            const performance = document.getElementById('performance').checked;
            
            // Update Google Consent Mode based on preferences
            gtag('consent', 'update', {
                'ad_storage': performance ? 'granted' : 'denied',
                'analytics_storage': analytics ? 'granted' : 'denied',
                'functionality_storage': functional ? 'granted' : 'denied',
                'personalization_storage': necessary ? 'granted' : 'denied',
            });

            // Record the consent action
            recordConsentAction('customize');
        });
    }

    // Optional: You can add a button for "Reject All" functionality in case the user rejects some cookies
    const rejectSomeBtn = document.getElementById('reject-some');
    if (rejectSomeBtn) {
        rejectSomeBtn.addEventListener('click', function() {
            // If the user rejects some categories, you can deny them specifically
            gtag('consent', 'update', {
                'ad_storage': 'denied',
                'analytics_storage': 'denied',
                'functionality_storage': 'denied',
                'personalization_storage': 'denied',
            });

            // Record the consent action for rejecting some cookies
            recordConsentAction('reject_some');
        });
    }

    // Fetch the consent logs from the backend (e.g., Firebase) and display them in the admin dashboard
    function loadConsentData() {
        firebase.database().ref('consent_logs').on('value', function(snapshot) {
            const consentLogs = snapshot.val();
            for (const logID in consentLogs) {
                const log = consentLogs[logID];
                displayConsentLog(log);
            }
        });
    }

    // Display a consent log in the admin panel (this function can be modified to display the log in your UI)
    function displayConsentLog(log) {
        // Example: You can display the log data as a new row in a table
        const logRow = document.createElement('tr');
        logRow.innerHTML = `
            <td>${log.sessionID}</td>
            <td>${log.action}</td>
            <td>${log.timestamp}</td>
        `;
        document.getElementById('consent-log-table').appendChild(logRow);
    }

    // Call loadConsentData to display the logs in real-time
    loadConsentData();
});
