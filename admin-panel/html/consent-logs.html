<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    style-src 'self' 'unsafe-inline';
    script-src 'self' 'unsafe-inline' https://therrpmarketing.github.io https://www.gstatic.com https://www.googleapis.com https://*.firebaseio.com;
    connect-src 'self' https://*.firebaseio.com https://*.googleapis.com wss://*.firebaseio.com;
    img-src 'self' data:;">
  <title>Consent Logs</title>
  <link rel="stylesheet" href="../../cmp-assets/cmp-css/cmp-style.css" />
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar"></div>

  <!-- Main Content -->
  <div class="main-content">
    <h1>Consent Logs</h1>
    <p>Track and view user consent actions in real time.</p>

    <div class="cookie-categories filters-actions">
      <div>
        <label for="start-date">Start Date:</label>
        <input type="date" id="start-date" />
      </div>
      <div>
        <label for="end-date">End Date:</label>
        <input type="date" id="end-date" />
        <button class="add-category-btn">Filter</button>
      </div>
      <div style="margin-left: auto;">
        <button class="export-btn">Export Logs</button>
        <button class="clear-btn">Clear Logs</button>
      </div>
    </div>

    <div class="cookie-categories">
      <table>
        <thead>
          <tr>
            <th>Session ID</th>
            <th>Action</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody id="consent-log-list">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div id="pagination-controls">
      <button id="prev-page" disabled>Previous</button>
      <span id="current-page">Page 1</span>
      <button id="next-page">Next</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB0yG8sGI47Zdncr21avyeJauW4Z6qJU8E",
      authDomain: "cookie-cmp-sys.firebaseapp.com",
      databaseURL: "https://cookie-cmp-sys-default-rtdb.firebaseio.com",
      projectId: "cookie-cmp-sys",
      storageBucket: "cookie-cmp-sys.appspot.com",
      messagingSenderId: "252822009652",
      appId: "1:252822009652:web:6bfbdf28d98953ccb89761"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentPage = 1;
    const logsPerPage = 10;

    function getActionLabel(action) {
      switch (action) {
        case 'accept_all': return 'Accepted All';
        case 'reject_all': return 'Rejected All';
        case 'save_preferences': return 'Saved Preferences';
        default: return action;
      }
    }

    function renderConsentLogs() {
      const tbody = document.getElementById("consent-log-list");
      db.ref("consentLogs").orderByChild("timestamp").on("value", (snapshot) => {
        tbody.innerHTML = "";
        const logs = snapshot.val();
        if (logs) {
          const logEntries = Object.keys(logs).reverse().map(key => logs[key]);
          const paginatedLogs = logEntries.slice((currentPage - 1) * logsPerPage, currentPage * logsPerPage);

          if (paginatedLogs.length === 0) {
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.setAttribute("colspan", "3");
            cell.textContent = "No logs found.";
            row.appendChild(cell);
            tbody.appendChild(row);
          } else {
            paginatedLogs.forEach((log) => {
              const row = document.createElement("tr");

              const sessionCell = document.createElement("td");
              sessionCell.textContent = log.session_id || "-";

              const actionCell = document.createElement("td");
              actionCell.textContent = getActionLabel(log.action);

              const timestampCell = document.createElement("td");
              timestampCell.textContent = log.timestamp
                ? new Date(log.timestamp).toLocaleString()
                : "-";

              row.appendChild(sessionCell);
              row.appendChild(actionCell);
              row.appendChild(timestampCell);
              tbody.appendChild(row);
            });
          }

          updatePaginationControls(logEntries.length);
        }
      });
    }

    function updatePaginationControls(totalLogs) {
      const totalPages = Math.ceil(totalLogs / logsPerPage);
      document.getElementById("prev-page").disabled = currentPage === 1;
      document.getElementById("next-page").disabled = currentPage === totalPages;
      document.getElementById("current-page").textContent = `Page ${currentPage}`;
    }

    document.getElementById("prev-page").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderConsentLogs();
      }
    });

    document.getElementById("next-page").addEventListener("click", () => {
      currentPage++;
      renderConsentLogs();
    });

    document.addEventListener("DOMContentLoaded", () => {
      renderConsentLogs();

      fetch('../../shared/sidebar.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('sidebar').innerHTML = html;
        })
        .catch(err => console.error('Sidebar error:', err));
    });
  </script>
</body>
</html>
